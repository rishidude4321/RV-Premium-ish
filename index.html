<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RV Plus</title>
    <link rel="icon" type="image/png" href="https://static.vecteezy.com/system/resources/previews/041/329/880/non_2x/a-cartoon-whale-on-a-transparent-background-free-png.png">
    <style>
        :root { 
            --bg-color: #0a0a0a; --card-bg: #141414; --text-color: #ffffff; 
            --accent-color: #00a4dc; --secondary-text: #aaa; 
        }
        .light-mode-base { --bg-color: #f4f4f4; --card-bg: #ffffff; --text-color: #1a1a1a; --secondary-text: #555; }
        
        body, html { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; transition: 0.3s; min-height: 100vh; overflow-x: hidden; }

        /* --- PROFILE GATE --- */
        #profileGate, #profileCreation {
            position: fixed; inset: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }

		#versionModal .modal-content::-webkit-scrollbar { width: 6px; }
		#versionModal .modal-content::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 10px; }
		#moreDetails h3 { border-left: 3px solid var(--accent-color); padding-left: 10px; }

		#profileGate > *:not(.version-banner):not(.modal) { position: relative; z-index: 1; } .version-banner { position: absolute; top: 25px; right: 25px; z-index: 100; } .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10001; }
        #profileGate { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; width: 100vw; background: #000; overflow: hidden; }
        .profile-container { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; margin-top: 30px; max-width: 80%; }
        .profile-item { cursor: pointer; transition: 0.3s; width: 150px; position: relative; }
        .profile-item:hover { transform: scale(1.1); }
        .profile-item img { width: 120px; height: 120px; border-radius: 4px; object-fit: cover; background: #222; border: 3px solid transparent; }
        .profile-item:hover img { border-color: #fff; }
        /* Update existing banner to be clickable */
        .version-banner { position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.1); color: var(--secondary-text); padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; z-index: 99; transition: 0.3s; }
        .version-banner:hover { background: rgba(255,255,255,0.2); color: #fff; border-color: var(--accent-color); }
        
        /* --- NAVIGATION --- */
        nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 40px; background: rgba(0,0,0,0.8); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); }
        .big-home-btn { font-weight: 900; font-size: 2.5rem; color: var(--accent-color); cursor:pointer; letter-spacing: -2px; transition: 0.2s; }
        .big-home-btn:hover { transform: scale(1.05); }

        .type-switcher { display: flex; gap: 20px; position: absolute; left: 50%; transform: translateX(-50%); }
        .type-btn { background: none; border: none; color: #888; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: 0.2s; border-bottom: 2px solid transparent; }
        .type-btn.active { color: #fff; border-color: var(--accent-color); }

        /* --- HERO & CONTROLS --- */
        .hero { height: 60vh; width: 100%; background-size: cover; background-position: center 20%; display: flex; align-items: flex-end; position: relative; }
        .hero-overlay { position: absolute; inset: 0; background: linear-gradient(to top, var(--bg-color), transparent 90%); }
        .hero-content { position: relative; padding: 40px; max-width: 600px; z-index: 10; }

        .controls { display: flex; justify-content: center; gap: 10px; padding: 20px; flex-wrap: wrap; }
        input, .ctrl-btn, select { padding: 12px 22px; border-radius: 25px; border: 1px solid #333; background: var(--card-bg); color: var(--text-color); outline: none; font-size: 1rem; }
        .ctrl-btn { cursor: pointer; border-color: var(--accent-color); font-weight: bold; transition: 0.2s; }
        .ctrl-btn.active-btn { background: var(--accent-color) !important; color: white !important; box-shadow: 0 0 10px var(--accent-color); }
        
        .search-container { position: relative; display: flex; align-items: center; }
        .search-icon-btn { position: absolute; right: 10px; background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; }

        /* --- MOVIE/TV CARDS --- */
        .category-section { margin-bottom: 40px; padding: 0 40px; }
        .category-title { font-size: 1.6rem; margin-bottom: 15px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .movie-row { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 20px; scroll-behavior: smooth; }
        .movie-row::-webkit-scrollbar { height: 4px; }
        .movie-row::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 10px; }

        .movie-card { flex: 0 0 165px; background: var(--card-bg); border-radius: 8px; overflow: hidden; transition: 0.3s; cursor: pointer; border: 1px solid #333; position: relative; height: fit-content; }
        .movie-card img { width: 100%; height: 245px; object-fit: cover; display: block; }
        .movie-card:hover { transform: scale(1.05); border-color: var(--accent-color); z-index: 5; }
        
        .remove-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; display: none; z-index: 10; font-weight: bold; }
        .movie-card:hover .remove-btn { display: block; }
        
        .coming-soon { position: absolute; top: 10px; left: 0; background: #fff; color: #000; padding: 3px 8px; font-size: 0.6rem; font-weight: 900; border-radius: 0 4px 4px 0; z-index: 2; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .view-all-card { flex: 0 0 165px; height: 245px; border: 2px dashed var(--accent-color); background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--accent-color); font-weight: bold; }

        /* --- MODALS & FIXED CAST --- */
        .modal { display: none; position: fixed; z-index: 2000; inset: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); overflow-y: auto; }
        .modal-content { background: var(--card-bg); margin: 5vh auto; padding: 35px; width: 85%; max-width: 900px; border-radius: 15px; border: 1px solid var(--accent-color); position: relative; cursor: default; }
        .modal-left { flex: 0 0 280px; }
        .modal-left img { width: 100%; border-radius: 10px; }
        .modal-right { flex: 1; min-width: 300px; }
        .modal-body { display: flex; gap: 30px; flex-wrap: wrap; }
        
        /* CAST SIZING - SECURED CIRCLES */
        .cast-row { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; }
        .cast-card { flex: 0 0 75px; text-align: center; cursor: pointer; }
        .cast-card img { width: 55px !important; height: 55px !important; border-radius: 50%; object-fit: cover; background: #222; border: 2px solid transparent; transition: 0.2s; }
        .cast-card:hover img { border-color: var(--accent-color); transform: scale(1.1); }
        .cast-card p { font-size: 0.6rem; margin-top: 5px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* SIMILAR CONTENT - BIGGER POSTERS */
        .similar-row { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; }
        .similar-card { flex: 0 0 140px; cursor: pointer; transition: 0.2s; }
        .similar-card:hover { transform: translateY(-5px); }
        .similar-card img { width: 100%; border-radius: 6px; height: 210px; object-fit: cover; }

        .row-settings-gear { cursor: pointer; opacity: 0.4; transition: 0.2s; font-size: 1.1rem; margin-left: 10px; }
        .full-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding: 20px 40px; }
        #qr-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3000; background: white; padding: 20px; border-radius: 10px; display: none; text-align: center; }
    </style>
</head>

<div id="themeModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content" style="max-width:500px; text-align:center;">
        <span style="position:absolute; right:20px; top:10px; cursor:pointer; font-size:2rem;" onclick="document.getElementById('themeModal').style.display='none'">&times;</span>
        <h2>Personalize Your Theme</h2>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; text-align: left;">
            <div>
                <label style="display:block; margin-bottom:10px;">Background Color</label>
                <input type="color" id="bgPicker" oninput="updateCustomTheme()" style="width:100%; height:40px; border:none; background:none; cursor:pointer;">
            </div>
            <div>
                <label style="display:block; margin-bottom:10px;">Accent Color</label>
                <input type="color" id="accentPicker" oninput="updateCustomTheme()" style="width:100%; height:40px; border:none; background:none; cursor:pointer;">
            </div>
        </div>

        <h3>Presets</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:20px;">
            <button class="ctrl-btn" style="background:#000; color:#00ff41; border-color:#00ff41;" onclick="applyPreset('#000000', '#00ff41', '#ffffff')">Matrix</button>
            <button class="ctrl-btn" style="background:#141414; color:#e50914; border-color:#e50914;" onclick="applyPreset('#141414', '#e50914', '#ffffff')">Netflix</button>
            <button class="ctrl-btn" style="background:#0b0e14; color:#7952b3; border-color:#7952b3;" onclick="applyPreset('#0b0e14', '#7952b3', '#ffffff')">Midnight</button>
            <button class="ctrl-btn" style="background:#f0f8ff; color:#007acc; border-color:#007acc;" onclick="applyPreset('#f0f8ff', '#007acc', '#1a1a1a')">Arctic Ice</button>
        </div>
        
        <button class="ctrl-btn" style="width:100%; background:var(--accent-color); color:white;" onclick="saveTheme()">Save & Close</button>
    </div>
</div>

<body>

<div id="profileGate" style="position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; width: 100vw; background: #000; overflow: hidden;">
    
    <div class="version-banner" style="position: absolute; top: 25px; right: 25px; z-index: 100;" onclick="document.getElementById('versionModal').style.display='flex'">
        Version 1.1 updated <span style="margin-left:8px;">‚ìò</span>
    </div>

    <h1 style="font-size: 3.5rem; margin-bottom: 20px;">Who's watching?</h1>
    <div id="profileList" class="profile-container"></div>
    <div style="margin-top: 50px; display:flex; gap:15px;">
        <button class="ctrl-btn" style="border-color:#555; color:#888;" onclick="toggleEditMode()" id="editBtn">Settings</button>
        <button class="ctrl-btn" onclick="openProfileCreation()">+ Add Profile</button>
    </div>
<div id="versionModal" class="modal" onclick="if(event.target==this) this.style.display='none'" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:10001;">
    <div class="modal-content" style="max-width:600px; width:90%; border:1px solid rgba(255,255,255,0.2); background:var(--card-bg); max-height:80vh; overflow-y:auto; padding:25px; position:relative;">
        <h2 style="color:var(--accent-color); margin-top:0;">Patch Notes</h2>
        <ul style="text-align:left; color:var(--secondary-text); font-size:0.9rem; line-height:1.6; margin-bottom:20px;">
            <li>üõ†Ô∏è V1.0: Basic Product, TV & Movies with User Friendly Frontend</li>
            <li>üõ†Ô∏è V1.1: Fixed TV Errors & Cloudflare Proxy Integration</li>
        </ul>

        <button class="ctrl-btn" style="width:auto; padding:5px 15px; font-size:0.8rem; margin-bottom:10px;" onclick="const d=document.getElementById('moreDetails'); d.style.display=d.style.display==='none'?'block':'none'">Click Here For More Details</button>

        <div id="moreDetails" style="display:none; text-align:left; border-top:1px solid #333; padding-top:15px; margin-top:10px;">
            <h3 style="color:#fff; font-size:1.1rem; margin:15px 0 5px 0;">Summary</h3>
            <p style="color:var(--secondary-text); font-size:0.85rem; margin-bottom:15px;">The backend utilizes Cloudflare Workers as a security layer to clean headers and block tracking.</p>
            
            <h3 style="color:#fff; font-size:1.1rem; margin:15px 0 5px 0;">API Documentation</h3>
            <ul style="color:var(--secondary-text); font-size:0.85rem; line-height:1.6; word-break: break-all;">
                <li><strong>Source:</strong> Cinemaos</li>
                <li><strong>Movie:</strong> cinemaos.tech/player/{tmdb_id}</li>
                <li><strong>TV:</strong> cinemaos.tech/player/{tmdb_id}/{s}/{e}</li>
                <li style="margin-top:10px; font-style: italic;">Note: Best used with adblockers; rare background downloads may occur.</li>
            </ul>

			<h3 style="color:#fff; font-size:1.1rem; margin:15px 0 5px 0;">All Features</h3>
			<ul style="color:var(--secondary-text); font-size:0.85rem; line-height:1.6; margin-bottom:15px;">
			    <li>Search bar with magnifying glass button</li>
			    <li>Extended media information & overviews</li>
			    <li>Similar movie and TV recommendations</li>
			    <li>Native TV Season & Episode selector</li>
			</ul>
        </div>

        <button class="ctrl-btn" style="width:100%; margin-top:20px;" onclick="document.getElementById('versionModal').style.display='none'">Close</button>
    </div>
</div>
<div id="profileCreation" style="display:none;">
    <h1 id="creationTitle">Profile Editor</h1>
    <input type="text" id="pName" class="ctrl-btn" style="width:350px; border-radius:8px;" placeholder="Name">
    <div id="avatarGallery" style="display:flex; gap:10px; margin:20px 0; flex-wrap:wrap; justify-content:center; max-width:600px;">
        <img src="https://www.pngall.com/wp-content/uploads/10/Walter-White-Breaking-Bad-PNG-Picture.png" style="width:100px; height:80px; border-radius:4px; cursor:pointer; border: 2px solid transparent;" onclick="selectAvatar(this)">
        <img src="https://images.squarespace-cdn.com/content/v1/528252b7e4b00150d03a4848/1503802775944-14J565KYKE9VUEXQZ7UX/ke17ZwdGBToddI8pDm48kJUlZr2Ql5GtSKWrQpjur5t7gQa3H78H3Y0txjaiv_0fDoOvxcdMmMKkDsyUqMSsMWxHk725yiiHCCLfrh8O1z5QPOohDIaIeljMHgDF5CVlOqpeNLcJ80NK65_fV7S1Uc2TsYyWrvo4cxLsTiAHD0wm8wv6KuSQ-vWcvdKCNFvRm4bjm9DAHF2kOsIZRJKXnA/RickAndMorty_MortyConfusedBlink1500.gif" style="width:80px; height:80px; border-radius:4px; cursor:pointer; border: 2px solid transparent;" onclick="selectAvatar(this)">
        <img src="https://www.icegif.com/wp-content/uploads/2021/11/icegif-656.gif" style="width:80px; height:80px; border-radius:4px; cursor:pointer; border: 2px solid transparent;" onclick="selectAvatar(this)">
        <img src="https://brian.carnell.com/wp-content/uploads/2019/12/spiderman-animated-gif.gif" style="width:80px; height:80px; border-radius:4px; cursor:pointer; border: 2px solid transparent;" onclick="selectAvatar(this)">
        <img src="https://www.icegif.com/wp-content/uploads/2023/10/icegif-808.gif" style="width:120px; height:80px; border-radius:4px; cursor:pointer; border: 2px solid transparent;" onclick="selectAvatar(this)">
    </div>
    <input type="text" id="pCustom" class="ctrl-btn" style="width:350px; border-radius:8px; font-size:0.8rem;" placeholder="Or Paste Image URL">
    <div id="deleteArea" style="margin: 15px 0;"></div>
    <div style="display:flex; gap:15px;">
        <button class="ctrl-btn" onclick="saveProfile()">Save</button>
        <button class="ctrl-btn" style="background:#333;" onclick="closeCreation()">Cancel</button>
    </div>
</div>

<nav id="mainNav" style="display:none;">
    <div class="big-home-btn" onclick="reloadHome()">RV Plus</div>
    <div class="type-switcher">
        <button id="btnMovies" class="type-btn active" onclick="switchType('movie')">Movies</button>
        <button id="btnTV" class="type-btn" onclick="switchType('tv')">TV Shows</button>
        <button id="btnAnything" class="type-btn" onclick="switchType('multi')">Anything</button>
    </div>
    <div style="display:flex; align-items:center; gap:20px;">
        <button class="ctrl-btn" onclick="openTheme()">Edit Theme</button>
        <button class="ctrl-btn" onclick="toggleQR()">QR</button>
        <div id="navUserPill" style="display:flex; align-items:center; gap:10px; cursor:pointer; border:1px solid var(--accent-color); padding:5px 12px; border-radius:20px;" onclick="logout()">
            <span id="navUserName"></span>
            <img id="navUserAvatar" style="width:30px; height:30px; border-radius:4px;">
        </div>
    </div>
</nav>

<div id="heroContainer"></div>

<header id="mainHeader" style="display:none;">
    <div class="controls">
        <button class="ctrl-btn" onclick="openFilter()">‚öôÔ∏è Filter</button>
        <div class="search-container">
            <input type="text" id="searchBar" placeholder="Search universe..." onkeypress="if(event.key=='Enter') triggerSearch()">
            <button class="search-icon-btn" onclick="triggerSearch()">üîç</button>
        </div>
        <button class="ctrl-btn" onclick="surpriseMe()">üé≤ Surprise</button>
    </div>
</header>

<div id="qr-container"><div id="qrcode"></div><button class="ctrl-btn" onclick="toggleQR()" style="color:rgb(255, 255, 255); margin-top:10px;">Close</button></div>

<div id="playerContainer" style="display:none; position:fixed; inset:0; z-index:9999; background:#000;">
    <video id="my-video" class="video-js" controls preload="auto" width="100%" height="100%"></video>
    <button onclick="closePlayer()" style="position:absolute; top:20px; right:20px;">Close</button>
</div>

<div id="continueSection" class="category-section" style="display:none;"><div class="category-title">Continue Watching</div><div id="continueRow" class="movie-row"></div></div>
<div id="myListSection" class="category-section" style="display:none;"><div class="category-title">My List</div><div id="myListRow" class="movie-row"></div></div>
<div id="dynamicContent"></div>
<div id="favSection" class="category-section" style="display:none;"><div class="category-title">Favorites</div><div id="favRow" class="movie-row"></div></div>

<div id="mainModal" class="modal" onclick="if(event.target==this) closeModal()">
    <div class="modal-content">
        <div class="nav-arrows" style="position:absolute; top:10px; left:20px; display:flex; gap:15px;">
            <button id="backBtn" class="arrow-btn" onclick="goBack()">‚óÑ</button>
            <button id="forwardBtn" class="arrow-btn" onclick="goForward()">‚ñ∫</button>
        </div>
        <span style="position:absolute; right:20px; top:10px; cursor:pointer; font-size:2rem;" onclick="closeModal()">&times;</span>
        <div id="modalInnerBody" class="modal-body"></div>
    </div>
</div>

<div id="filterModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content" style="max-width:500px; text-align:left;">
        <h2>Advanced Filter</h2>
        <div style="display:grid; gap:12px;">
            <label>Genre</label>
            <select id="fGenre" class="ctrl-btn" style="width:100%; border-radius:10px;">
                <option value="">All Genres</option>
                <option value="28">Action</option><option value="12">Adventure</option><option value="16">Animation</option>
                <option value="35">Comedy</option><option value="80">Crime</option><option value="18">Drama</option>
                <option value="10749">Romance</option><option value="878">Sci-Fi</option><option value="53">Thriller</option>
            </select>
            <label>Sort By</label>
            <select id="fSort" class="ctrl-btn" style="width:100%; border-radius:10px;">
                <option value="popularity.desc">Trending</option>
                <option value="vote_average.desc">Rating High-Low</option>
                <option value="primary_release_date.desc">Newest First</option>
            </select>
            <button class="ctrl-btn" style="background:var(--accent-color); color:white;" onclick="applyFilters()">Apply</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js">

// --- THEME ENGINE ---
function openTheme() {
    document.getElementById('themeModal').style.display = 'block';
    // Get current colors to sync the pickers when opened
    const style = getComputedStyle(document.documentElement);
    document.getElementById('bgPicker').value = rgbToHex(style.getPropertyValue('--bg-color').trim());
    document.getElementById('accentPicker').value = rgbToHex(style.getPropertyValue('--accent-color').trim());
}

function updateCustomTheme() {
    const bg = document.getElementById('bgPicker').value;
    const accent = document.getElementById('accentPicker').value;
    
    document.documentElement.style.setProperty('--bg-color', bg);
    document.documentElement.style.setProperty('--accent-color', accent);
    document.documentElement.style.setProperty('--card-bg', adjustColor(bg, 10));
}

function applyPreset(bg, accent, text) {
    document.documentElement.style.setProperty('--bg-color', bg);
    document.documentElement.style.setProperty('--accent-color', accent);
    document.documentElement.style.setProperty('--text-color', text);
    document.documentElement.style.setProperty('--card-bg', adjustColor(bg, 10));
    
    // Sync pickers with the preset
    document.getElementById('bgPicker').value = bg;
    document.getElementById('accentPicker').value = accent;
}

function saveTheme() {
    // You can add localStorage saving here if you want it to persist after refresh
    document.getElementById('themeModal').style.display = 'none';
}

// Helper to calculate a card color (lightens/darkens the hex)
function adjustColor(hex, amt) {
    let usePound = false;
    if (hex[0] == "#") { hex = hex.slice(1); usePound = true; }
    let num = parseInt(hex, 16);
    let r = (num >> 16) + amt;
    let g = (num >> 8 & 0x00FF) + amt;
    let b = (num & 0x0000FF) + amt;
    r = Math.max(0, Math.min(255, r));
    g = Math.max(0, Math.min(255, g));
    b = Math.max(0, Math.min(255, b));
    return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
}

// Helper to convert computed RGB to Hex for the pickers
function rgbToHex(rgb) {
    if (rgb.startsWith('#')) return rgb;
    const parts = rgb.match(/\d+/g);
    if (!parts) return "#0a0a0a";
    return "#" + parts.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
}

</script>

<script>

// 1. ADD THIS AT THE TOP OF THE SECOND SCRIPT TAG
const PROXY_URL = "https://rv-plus.rishivira4321.workers.dev/";

const API_KEY = '31b33cade35075a7a011c88568bb1070';
// ... rest of your variables ...

// 2. FIND YOUR OLD playContent AND REPLACE IT WITH THIS:
async function playContent(id, t, p, type) {
    // 1. History and List Logic
    activeUser.continueWatching = [{id, title:t, poster_path:p, type}, ...activeUser.continueWatching.filter(x=>x.id!=id)].slice(0,10);
    save(); 

    // 2. Build Proxy URL
    const targetUrl = type === 'movie' 
        ? `https://vidsrc.me/embed/movie?tmdb=${id}` 
        : `https://vidsrc.me/embed/tv?tmdb=${id}&sea=1&epi=1`;
    const proxyUrl = PROXY_URL + "?url=" + encodeURIComponent(targetUrl);

    // 3. Setup the Fullscreen Overlay
    let playerDiv = document.getElementById('fsPlayerOverlay');
    if (!playerDiv) {
        playerDiv = document.createElement('div');
        playerDiv.id = 'fsPlayerOverlay';
        // This style ensures the background is black and anything inside stays centered
        playerDiv.style = "position:fixed; inset:0; z-index:10000; background:#000; display:flex; justify-content:center; align-items:center; overflow:hidden;";
        document.body.appendChild(playerDiv);
    }

    playerDiv.innerHTML = `<div style="color:white; font-family:sans-serif;">Loading Secure Stream...</div>`;
    
    try {
        const response = await fetch(proxyUrl);
        const html = await response.text();
        
        // 4. The Aspect-Ratio Lock
        // This forces a 16:9 ratio and prevents the "stretched" look from your screenshot
        playerDiv.innerHTML = `
            <div style="width:95vw; max-width:1200px; position:relative;">
                <div style="padding:15px; background:rgba(30,30,30,0.9); display:flex; justify-content:space-between; align-items:center; border-radius:8px 8px 0 0;">
                    <span style="font-weight:bold; color:var(--accent-color);">${t}</span>
                    <button class="ctrl-btn" onclick="document.getElementById('fsPlayerOverlay').remove()" style="padding:5px 15px;">‚úï Close Player</button>
                </div>
                <div style="position:relative; width:100%; height:0; padding-bottom:56.25%; background:#000; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
                    <div id="proxyContent" style="position:absolute; inset:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
                        ${html}
                    </div>
                </div>
            </div>
        `;

        // 5. Cleanup injected styles
        // Some proxies inject 100% height styles that cause the stretching
        const injectedIframe = document.querySelector('#proxyContent iframe');
        if (injectedIframe) {
            injectedIframe.style.height = "100%";
            injectedIframe.style.width = "100%";
        }

    } catch (err) {
        playerDiv.innerHTML = `<div style="color:red; padding:20px;">Error loading stream. Check Worker proxy.</div>`;
    }
}
const IMG_PATH = 'https://image.tmdb.org/t/p/w1280', POSTER_PATH = 'https://image.tmdb.org/t/p/w500';

let curT = 'movie', activeUser = null, editMode = false, selectedAv = '';
let modalHistory = [], historyIndex = -1;
let users = JSON.parse(localStorage.getItem('rv_users')) || [{id:1, name:'Guest', avatar:'https://image.tmdb.org/t/p/w185/39U9p9WvK8M4hN8G189R5G0vL0G.jpg', myList:[], favorites:[], continueWatching:[], rowPrefs:[0,1,2,3,4,5,6,7,8,9]}];

const categoryData = [
    { n: 'Trending', u: `https://api.themoviedb.org/3/trending/movie/day?api_key=${API_KEY}` },
    { n: 'Recently Added', u: `https://api.themoviedb.org/3/movie/now_playing?api_key=${API_KEY}` },
    { n: 'High Rated', u: `https://api.themoviedb.org/3/movie/top_rated?api_key=${API_KEY}` },
    { n: 'MCU Universe', u: `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&with_companies=420` },
    { n: 'Sci-Fi Universe', u: `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&with_genres=878` },
    { n: 'Classics', u: `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&sort_by=vote_average.desc&vote_count.gte=15000` },
    { n: 'Horror', u: `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&with_genres=27` },
    { n: 'Action', u: `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&with_genres=28` },
    { n: 'Hidden Gems', u: `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&vote_average.gte=8&vote_count.lte=2000` },
    { n: 'Holiday Hits', u: `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&with_keywords=207317` }
];

function switchType(t) {
    curT = t;
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(t === 'movie' ? 'btnMovies' : t === 'tv' ? 'btnTV' : 'btnAnything').classList.add('active');
    initApp();
}

function renderProfiles() {
    document.getElementById('profileList').innerHTML = users.map(u => `
        <div class="profile-item" onclick="handleProfile(${u.id})">
            ${editMode ? '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;font-size:2rem;color:white;border-radius:4px;">‚úé</div>' : ''}
            <img src="${u.avatar}"><p>${u.name}</p>
        </div>`).join('');
}
function handleProfile(id) { if(editMode) openProfileCreation(id); else login(id); }
function toggleEditMode() { editMode = !editMode; document.getElementById('editBtn').innerText = editMode?'Done':'Settings'; renderProfiles(); }
function login(id) {
    activeUser = users.find(u => u.id === id);
    document.getElementById('profileGate').style.display = 'none';
    document.getElementById('mainNav').style.display = 'flex';
    document.getElementById('mainHeader').style.display = 'block';
    document.getElementById('navUserName').innerText = activeUser.name;
    document.getElementById('navUserAvatar').src = activeUser.avatar;
    initApp();
}
function logout() { location.reload(); }
function reloadHome() { initApp(); }

async function initApp() {
    updateLists();
    document.getElementById('dynamicContent').innerHTML = '';
    const base = curT === 'multi' ? 'trending/all/day' : `trending/${curT}/day`;
    const hRes = await fetch(`https://api.themoviedb.org/3/${base}?api_key=${API_KEY}`);
    const hData = await hRes.json();
    setupHero(hData.results[0]);
    
    // Map current type categories
    const cats = curT === 'tv' ? [
        {n:'Trending TV', u:`https://api.themoviedb.org/3/trending/tv/day?api_key=${API_KEY}`},
        {n:'Top Rated TV', u:`https://api.themoviedb.org/3/tv/top_rated?api_key=${API_KEY}`},
        {n:'On Air', u:`https://api.themoviedb.org/3/tv/on_the_air?api_key=${API_KEY}`},
        {n:'Sci-Fi/Fantasy TV', u:`https://api.themoviedb.org/3/discover/tv?api_key=${API_KEY}&with_genres=10765`},
        {n:'Action TV', u:`https://api.themoviedb.org/3/discover/tv?api_key=${API_KEY}&with_genres=10759`},
        {n:'Comedy TV', u:`https://api.themoviedb.org/3/discover/tv?api_key=${API_KEY}&with_genres=35`},
        {n:'Documentary TV', u:`https://api.themoviedb.org/3/discover/tv?api_key=${API_KEY}&with_genres=99`},
        {n:'Mystery TV', u:`https://api.themoviedb.org/3/discover/tv?api_key=${API_KEY}&with_genres=9648`},
        {n:'Reality TV', u:`https://api.themoviedb.org/3/discover/tv?api_key=${API_KEY}&with_genres=10764`},
        {n:'Animation TV', u:`https://api.themoviedb.org/3/discover/tv?api_key=${API_KEY}&with_genres=16`}
    ] : categoryData;

    for(let c of cats) {
        const r = await fetch(c.u); const d = await r.json();
        renderRow(c.n, d.results, c.u);
    }
}

function renderRow(title, movies, url) {
    const div = document.createElement('div'); div.className = 'category-section';
    div.innerHTML = `<div class="category-title"><span>${title}</span> <span style="font-size:0.7rem; color:var(--accent-color); cursor:pointer;" onclick="viewAll('${title}', '${url}')">VIEW ALL ‚ùØ</span></div>
    <div class="movie-row">${movies.slice(0,20).map(m => createCard(m)).join('')}
    <div class="view-all-card" onclick="viewAll('${title}', '${url}')">SEE ALL</div></div>`;
    document.getElementById('dynamicContent').appendChild(div);
}

function createCard(m) {
    const type = m.media_type || (m.title ? 'movie' : 'tv');
    const isSoon = new Date(m.release_date || m.first_air_date) > new Date();
    return `<div class="movie-card" onclick="navigateTo('${type}', ${m.id})">
        ${isSoon?`<div class="coming-soon">Soon: ${m.release_date||m.first_air_date}</div>`:''}
        <img src="${m.poster_path ? POSTER_PATH+m.poster_path : 'https://via.placeholder.com/200x300'}">
    </div>`;
}

async function navigateTo(type, id) {
    historyIndex++; modalHistory = modalHistory.slice(0, historyIndex);
    modalHistory.push({type, id}); 
    if(type === 'person') loadPerson(id); else loadDetails(type, id);
}

async function loadDetails(type, id) {
    document.getElementById('mainModal').style.display = 'block';
    const inner = document.getElementById('modalInnerBody'); inner.innerHTML = "";
    const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${API_KEY}&append_to_response=credits,similar`);
    const m = await res.json();
    const inL = activeUser.myList.some(x=>x.id==m.id), isF = activeUser.favorites.some(x=>x.id==m.id);
    const title = m.title || m.name;

    // --- SHARED HEADER (Same for Movies & TV) ---
    let html = `
    <div class="modal-left"><img src="${POSTER_PATH+m.poster_path}"></div>
    <div class="modal-right">
        <h2>${title}</h2>
        <div style="margin:10px 0;"><span class="rating-badge tomato">üçÖ ${Math.floor(m.vote_average*10)}%</span> <span class="rating-badge critic">‚≠ê ${m.vote_average.toFixed(1)}</span></div>
        <p style="font-size:0.9rem; max-height:100px; overflow-y:auto; margin-bottom:15px;">${m.overview}</p>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            ${type === 'movie' ? `<button class="ctrl-btn" onclick="playContent(${m.id},'${title.replace(/'/g,"")}','${m.poster_path}','movie')">Watch Now</button>` : ''}
            <button id="lBtn" class="ctrl-btn ${inL?'active-btn':''}" onclick="toggle('myList', ${m.id},'${title.replace(/'/g,"")}','${m.poster_path}','${type}')">${inL?'‚úì List':'+ List'}</button>
            <button id="fBtn" class="ctrl-btn ${isF?'active-btn':''}" onclick="toggle('favorites', ${m.id},'${title.replace(/'/g,"")}','${m.poster_path}','${type}')">+ Favorite</button>
        </div>`;

    // --- CONDITIONAL CONTENT ---
    if (type === 'tv') {
        // TV ONLY: Select Episode UI
        html += `
        <div style="display:flex; gap:20px; border-bottom:1px solid #333; margin-bottom:15px;">
            <button id="tabEpi" class="type-btn active" onclick="switchTab('episodes', ${m.id})">Select Episode</button>
            <button id="tabSim" class="type-btn" onclick="switchTab('similar', ${m.id}, '${type}')">Similar Content</button>
        </div>
        <div id="tabContent" style="max-height:350px; overflow-y:auto;"></div>`;
    } else {
        // MOVIE ONLY: Original Cast & SimilarRows
        html += `
        <div class="cast-row">${m.credits.cast.slice(0,8).map(c=>`<div class="cast-card" onclick="navigateTo('person', ${c.id})"><img src="${c.profile_path?POSTER_PATH+c.profile_path:'https://via.placeholder.com/60'}"><p>${c.name}</p></div>`).join('')}</div>
        <h3 style="margin-top:30px;">Similar Content</h3>
        <div class="similar-row">${m.similar.results.slice(0,6).map(s=>`<div class="similar-card" onclick="navigateTo('movie',${s.id})"><img src="${POSTER_PATH+s.poster_path}"></div>`).join('')}</div>`;
    }

    html += `</div>`; // Close modal-right
    inner.innerHTML = html;

    if (type === 'tv') renderSeasonPicker(m.id, m.number_of_seasons);
}

async function renderSeasonPicker(id, total) { let h = `<select class="ctrl-btn" style="width:100%; margin-bottom:15px;" onchange="loadEpisodes(${id}, this.value)">`; for(let i=1; i<=total; i++) h += `<option value="${i}">Season ${i}</option>`; h += `</select><div id="epiGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px;"></div>`; document.getElementById('tabContent').innerHTML = h; loadEpisodes(id, 1); }

async function loadEpisodes(id, s) { const g = document.getElementById('epiGrid'); g.innerHTML = "Loading..."; const r = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${s}?api_key=${API_KEY}`); const d = await r.json(); g.innerHTML = d.episodes.map(e => `<div class="similar-card" onclick="playTV(${id}, ${s}, ${e.episode_number}, '${e.name.replace(/'/g,"")}')"><img src="${e.still_path ? POSTER_PATH+e.still_path : 'https://via.placeholder.com/140x80'}" style="width:100%; border-radius:4px;"><p style="font-size:0.7rem; font-weight:bold; margin-top:5px;">E${e.episode_number}: ${e.name}</p></div>`).join(''); }

function playTV(id, s, e, title) { const url = `https://vidsrc.to/embed/tv/${id}/${s}/${e}`; const proxy = PROXY_URL + "?url=" + encodeURIComponent(url); openPlayerOverlay(proxy, `${title} - S${s} E${e}`); }

async function openPlayerOverlay(url, displayTitle) { let p = document.getElementById('fsPlayerOverlay'); if (!p) { p = document.createElement('div'); p.id = 'fsPlayerOverlay'; p.style = "position:fixed; inset:0; z-index:10000; background:#000; display:flex; justify-content:center; align-items:center; overflow:hidden;"; document.body.appendChild(p); } p.innerHTML = `<div style="color:white;">Loading Secure Stream...</div>`; try { const r = await fetch(url); let h = await r.text(); h = h.replace(/<style([\s\S]*?)<\/style>/gi, ''); p.innerHTML = `<div style="width:98vw; max-width:1600px; position:relative;"><div style="padding:10px 15px; background:rgba(30,30,30,0.9); display:flex; justify-content:space-between; align-items:center; border-radius:8px 8px 0 0;"><span style="font-weight:bold; color:var(--accent-color);">${displayTitle}</span><button class="ctrl-btn" onclick="document.getElementById('fsPlayerOverlay').remove()" style="padding:5px 15px;">‚úï Close Player</button></div><div style="position:relative; width:100%; height:0; padding-bottom:56.25%; background:#000; box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow:hidden;"><div id="proxyContent" style="position:absolute; inset:0; width:100%; height:100%;">${h}</div></div></div>`; } catch (e) { p.innerHTML = `<div style="color:red; padding:20px;">Error loading stream.</div>`; } }
    
async function loadPerson(id) {
    const res = await fetch(`https://api.themoviedb.org/3/person/${id}?api_key=${API_KEY}&append_to_response=combined_credits`);
    const p = await res.json();
    document.getElementById('modalInnerBody').innerHTML = `
    <div class="modal-left"><img src="${POSTER_PATH+p.profile_path}"></div>
    <div class="modal-right">
        <h2>${p.name}</h2>
        <p style="max-height:200px; overflow-y:auto;">${p.biography || 'No biography available.'}</p>
        <h3>Known For</h3>
        <div class="similar-row">${p.combined_credits.cast.slice(0,10).map(m => `<div class="similar-card" onclick="navigateTo('${m.media_type}', ${m.id})"><img src="${POSTER_PATH+m.poster_path}"></div>`).join('')}</div>
    </div>`;
}

function toggle(k, id, t, p, type) { if(activeUser[k].some(x=>x.id==id)) activeUser[k]=activeUser[k].filter(x=>x.id!=id); else activeUser[k].push({id, title:t, poster_path:p, type}); save(); document.getElementById(k=='myList'?'lBtn':'fBtn').classList.toggle('active-btn'); }
function save() { localStorage.setItem('rv_users', JSON.stringify(users)); updateLists(); }
function updateLists() {
    ['continueWatching', 'myList', 'favorites'].forEach(k => {
        const row = k=='continueWatching'?'continueRow':k=='myList'?'myListRow':'favRow';
        const sec = k=='continueWatching'?'continueSection':k=='myList'?'myListSection':'favSection';
        if(activeUser[k] && activeUser[k].length > 0) {
            document.getElementById(sec).style.display = 'block';
            document.getElementById(row).innerHTML = activeUser[k].map(m => `<div class="movie-card"><button class="remove-btn" onclick="activeUser['${k}']=activeUser['${k}'].filter(x=>x.id!=${m.id});save();">√ó</button><div onclick="navigateTo('${m.type}', ${m.id})"><img src="${POSTER_PATH+m.poster_path}"></div></div>`).join('');
        } else document.getElementById(sec).style.display = 'none';
    });
}

function triggerSearch() { executeSearch(document.getElementById('searchBar').value); }
async function executeSearch(q) { 
    document.getElementById('heroContainer').innerHTML = ''; 
    document.getElementById('dynamicContent').innerHTML = `<h1 style="padding-left:40px;">Results</h1><div class="full-grid" id="gridBody"></div>`; 
    const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${API_KEY}&query=${q}`); 
    const d = await r.json(); 
    d.results.forEach(m => { if(m.poster_path) document.getElementById('gridBody').innerHTML += createCard(m); }); 
}
function setupHero(m) {
    const type = m.media_type || (m.title ? 'movie' : 'tv');
    document.getElementById('heroContainer').innerHTML = `<div class="hero" style="background-image:url(${IMG_PATH+m.backdrop_path})"><div class="hero-overlay"></div><div class="hero-content"><h1>${m.title||m.name}</h1><p>${m.overview}</p><button class="ctrl-btn" onclick="navigateTo('${type}', ${m.id})">More Info</button></div></div>`; 
}
function closeModal() { document.getElementById('mainModal').style.display='none'; modalHistory=[]; historyIndex=-1; }
function goBack() { if(historyIndex>0) { historyIndex--; const h = modalHistory[historyIndex]; if(h.type=='person') loadPerson(h.id); else loadDetails(h.type, h.id); } }
function goForward() { if(historyIndex<modalHistory.length-1) { historyIndex++; const h = modalHistory[historyIndex]; if(h.type=='person') loadPerson(h.id); else loadDetails(h.type, h.id); } }
function updateArrows() { document.getElementById('backBtn').disabled = historyIndex<=0; document.getElementById('forwardBtn').disabled = historyIndex >= modalHistory.length-1; }

// --- THEME ENGINE ---
function openTheme() {
    const modal = document.getElementById('themeModal');
    if (modal) modal.style.display = 'block';
    
    // Get current colors to sync the pickers
    const style = getComputedStyle(document.documentElement);
    // We trim to remove any accidental whitespace from the CSS variable
    const currentBg = style.getPropertyValue('--bg-color').trim();
    const currentAccent = style.getPropertyValue('--accent-color').trim();
    
    document.getElementById('bgPicker').value = rgbToHex(currentBg);
    document.getElementById('accentPicker').value = rgbToHex(currentAccent);
}

function updateCustomTheme() {
    const bg = document.getElementById('bgPicker').value;
    const accent = document.getElementById('accentPicker').value;
    
    applyThemeStyles(bg, accent, '#ffffff'); // Default to white text for custom
}

function applyPreset(bg, accent, text) {
    applyThemeStyles(bg, accent, text);
    
    // Sync pickers with the preset colors
    document.getElementById('bgPicker').value = bg;
    document.getElementById('accentPicker').value = accent;
}

function applyThemeStyles(bg, accent, text) {
    const root = document.documentElement;
    const cardBg = adjustColor(bg, 10);
    
    root.style.setProperty('--bg-color', bg);
    root.style.setProperty('--accent-color', accent);
    root.style.setProperty('--text-color', text);
    root.style.setProperty('--card-bg', cardBg);
    
    // Force immediate body background update to ensure visual change
    document.body.style.backgroundColor = bg;
}

function saveTheme() {
    const modal = document.getElementById('themeModal');
    if (modal) modal.style.display = 'none';
    
    // Save to localStorage so it persists on refresh
    const themeSettings = {
        bg: document.documentElement.style.getPropertyValue('--bg-color'),
        accent: document.documentElement.style.getPropertyValue('--accent-color'),
        text: document.documentElement.style.getPropertyValue('--text-color')
    };
    localStorage.setItem('rv_theme_persistent', JSON.stringify(themeSettings));
}

// Fixed Color Adjuster (Corrected Bit-Shifting)
function adjustColor(hex, amt) {
    let usePound = false;
    if (hex[0] == "#") { hex = hex.slice(1); usePound = true; }
    let num = parseInt(hex, 16);
    
    let r = (num >> 16) + amt;
    let g = ((num >> 8) & 0x00FF) + amt;
    let b = (num & 0x0000FF) + amt;
    
    r = Math.max(0, Math.min(255, r));
    g = Math.max(0, Math.min(255, g));
    b = Math.max(0, Math.min(255, b));
    
    return (usePound ? "#" : "") + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
}

// RGB to Hex Converter
function rgbToHex(rgb) {
    if (!rgb || rgb === "") return "#0a0a0a";
    if (rgb.startsWith('#')) return rgb;
    const parts = rgb.match(/\d+/g);
    if (!parts) return "#0a0a0a";
    return "#" + parts.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
}

// Load saved theme on startup
(function() {
    const saved = localStorage.getItem('rv_theme_persistent');
    if (saved) {
        const t = JSON.parse(saved);
        applyThemeStyles(t.bg, t.accent, t.text);
    }
})();

function openFilter() { document.getElementById('filterModal').style.display='block'; }
async function applyFilters() {
    const g = document.getElementById('fGenre').value, s = document.getElementById('fSort').value;
    let url = `https://api.themoviedb.org/3/discover/${curT === 'multi' ? 'movie' : curT}?api_key=${API_KEY}&sort_by=${s}`;
    if(g) url += `&with_genres=${g}`;
    viewAll('Filtered Results', url); document.getElementById('filterModal').style.display='none';
}
async function viewAll(t, u, append=false) {
    if(!append) { window.scrollTo(0,0); document.getElementById('heroContainer').innerHTML=''; document.getElementById('dynamicContent').innerHTML = `<div style="padding:20px 40px;display:flex;justify-content:space-between;"><h1>${t}</h1><button class="ctrl-btn" onclick="reloadHome()">Home</button></div><div id="gridBody" class="full-grid"></div><div style="text-align:center;padding:40px;"><button class="ctrl-btn" onclick="viewAll('${t}','${u}',true)">Load 60 More</button></div>`; currP=0; actU=u; }
    for(let i=0; i<3; i++) { currP++; const r = await fetch(`${actU}&page=${currP}`); const d = await r.json(); d.results.forEach(m=> { if(m.poster_path) document.getElementById('gridBody').innerHTML += createCard(m); }); }
}
function toggleQR() { const q = document.getElementById('qr-container'); q.style.display = q.style.display=='block'?'none':'block'; document.getElementById('qrcode').innerHTML=''; new QRCode(document.getElementById("qrcode"), window.location.href); }
function surpriseMe() { fetch(`https://api.themoviedb.org/3/movie/top_rated?api_key=${API_KEY}`).then(r=>r.json()).then(d=>navigateTo('movie', d.results[Math.floor(Math.random()*d.results.length)].id)); }
// Updated to handle IDs for editing/deleting
let editingProfileId = null;

function openProfileCreation(id = null) {
    editingProfileId = id;
    const deleteArea = document.getElementById('deleteArea');
    const title = document.getElementById('creationTitle');
    const nameInput = document.getElementById('pName');
    const customAvInput = document.getElementById('pCustom');

    document.getElementById('profileGate').style.display = 'none';
    document.getElementById('profileCreation').style.display = 'flex';

    if (id) {
        // EDIT MODE
        const profile = users.find(u => u.id === id);
        title.innerText = "Edit Profile";
        nameInput.value = profile.name;
        selectedAv = profile.avatar;
        
        // Add Delete Button (Only if it's not the last profile or Guest)
        if (users.length > 1) {
            deleteArea.innerHTML = `<button class="ctrl-btn" style="background:#800; color:white; width:100%;" onclick="deleteProfile(${id})">Delete Profile</button>`;
        } else {
            deleteArea.innerHTML = '';
        }
    } else {
        // NEW PROFILE MODE
        title.innerText = "Create Profile";
        nameInput.value = '';
        customAvInput.value = '';
        deleteArea.innerHTML = '';
        selectedAv = '';
    }
}

function deleteProfile(id) {
    if (confirm("Are you sure you want to delete this profile?")) {
        users = users.filter(u => u.id !== id);
        localStorage.setItem('rv_users', JSON.stringify(users));
        renderProfiles();
        closeCreation();
    }
}

function decodeSource(encoded) {
    // Logic from your "VidSrc" notes: Reverse -> Subtract 1 -> Hex to ASCII
    const reversed = encoded.split('').reverse().join('');
    let adjusted = '';
    for (let i = 0; i < reversed.length; i++) {
        adjusted += String.fromCharCode(reversed.charCodeAt(i) - 1);
    }
    // Convert hex pairs to actual URL string
    return adjusted.match(/.{1,2}/g).map(byte => String.fromCharCode(parseInt(byte, 16))).join('');
}

function saveProfile() {
    const n = document.getElementById('pName').value;
    const customAv = document.getElementById('pCustom').value;
    const finalAv = customAv || selectedAv || 'https://image.tmdb.org/t/p/w185/39U9p9WvK8M4hN8G189R5G0vL0G.jpg';

    if (!n) {
        alert("Please enter a name");
        return;
    }

    if (editingProfileId) {
        // Update existing
        const index = users.findIndex(u => u.id === editingProfileId);
        users[index].name = n;
        users[index].avatar = finalAv;
    } else {
        // Add new
        users.push({
            id: Date.now(),
            name: n,
            avatar: finalAv,
            myList: [],
            favorites: [],
            continueWatching: [],
            rowPrefs: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
        });
    }

    localStorage.setItem('rv_users', JSON.stringify(users));
    renderProfiles();
    closeCreation();
}
function closeCreation() { document.getElementById('profileCreation').style.display='none'; document.getElementById('profileGate').style.display='flex'; }
function selectAvatar(element) {
    // Remove border from all avatars
    document.querySelectorAll('#avatarGallery img').forEach(img => img.style.borderColor = 'transparent');
    // Add border to selected
    element.style.borderColor = 'var(--accent-color)';
    selectedAv = element.src;
}

renderProfiles();
</script>
</body>
</html>
